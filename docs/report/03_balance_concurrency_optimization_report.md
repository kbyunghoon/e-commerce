# Spring Retry μ μ©μ„ ν†µν• λ‚™κ΄€μ  λ½ μ¶©λ ν•΄κ²° μ „/ν›„ λΉ„κµ

## 1. κ°μ”

ν¬μΈνΈ μ¶©μ „/μ°¨κ° μ‹μ¤ν…μ—μ„ λ°μƒν•λ” λ‚™κ΄€μ  λ½ μ¶©λ λ¬Έμ λ¥Ό Spring Retryλ¥Ό μ‚¬μ© μ „/ν›„ λΉ„κµλ¥Ό μ„ν• λ³΄κ³ μ„

## 2. λ¬Έμ  μƒν™©

### 2.1 λ‚™κ΄€μ  λ½κ³Ό λ™μ‹μ„± μ¶©λ

λ‚™κ΄€μ  λ½μ€ λ°μ΄ν„°λ² μ΄μ¤ λ λ²¨μ—μ„ λ™μ‹μ„±μ„ μ μ–΄ν•λ” λ°©λ²•μΌλ΅, μ—”ν‹°ν‹°μ λ²„μ „(`Version`) μ •λ³΄λ¥Ό ν†µν•΄ μ¶©λμ„ κ°μ§€ν•λ‹¤.

μ—¬λ¬ νΈλμ­μ…μ΄ λ™μ‹μ— κ°™μ€ λ°μ΄ν„°λ¥Ό μμ •ν•λ ¤ ν•  λ• `ObjectOptimisticLockingFailureException`μ΄ λ°μƒν•λ‹¤.

### 2.2 ν…μ¤νΈ κ²°κ³Ό λ¶„μ„ (Spring Retry μ μ© μ „)

| ν…μ¤νΈ μΌ€μ΄μ¤                            | μ„±κ³µ | μ‹¤ν¨ | μ„±κ³µλ¥  |
|------------------------------------|----|----|-----|
| λ€λ‰ ν¬μΈνΈ μ¶©μ „ λ™μ‹μ„± ν…μ¤νΈ (50μ¤λ λ“, 100μ‘μ—…)   | 38 | 62 | 38% |
| μ μ € ν¬μΈνΈ μ°¨κ° λ™μ‹μ„± ν…μ¤νΈ (5μ¤λ λ“, 10μ‘μ—…)     | 4  | 6  | 40% |
| μ μ € ν¬μΈνΈ μ¶©μ „ 10λ² λ™μ‹μ„± ν…μ¤νΈ (5μ¤λ λ“, 10μ‘μ—…) | 4  | 6  | 40% |

**μ£Όμ” λ¬Έμ μ **

- λ™μ‹μ„±μ΄ λ†’μ„μλ΅ μ¶©λ λ°μƒλ¥  κΈ‰μ¦
- λ€λ‰ μ‘μ—…μ—μ„ 62%μ λ†’μ€ μ‹¤ν¨μ¨
- λΉ„μ¦λ‹μ¤ λ΅μ§μ€ μ •μƒμ΄μ§€λ§ κΈ°μ μ  μ¶©λλ΅ μΈν• μ‹¤ν¨

## 3. Spring Retry

### 3.1 Spring Retryλ€?

Spring Retryλ” μ‹¤ν¨ν• μ‘μ—…μ„ μλ™μΌλ΅ μ¬μ‹λ„ν•λ” κΈ°λ¥μ„ μ κ³µν•λ” Spring ν”„λ μ„μ›ν¬μ λ¨λ“μ΄λ‹¤.

**ν•µμ‹¬ νΉμ§•**

- μ–΄λ…Έν…μ΄μ… κΈ°λ°μ κ°„λ‹¨ν• μ„¤μ •μΌλ΅ **μ„ μ–Έμ  μ¬μ‹λ„**κ°€ κ°€λ¥ν•λ‹¤.
- μ¬μ‹λ„ κ°„κ²©μ„ μ΅°μ •ν•μ—¬ **μ‹μ¤ν… λ¶€ν• λ¶„μ‚°**μ΄ κ°€λ¥ν•λ‹¤.
- νΉμ • μμ™Έμ— λ€ν•΄μ„λ§ μ¬μ‹λ„ μν–‰ν•  μ μλ‹¤. (λ™μ‹μ„± μ¶©λ ν•΄κ²°ν•κΈ° μ„ν•΄ νΉμ • μμ™Έλ΅ μ΄λ²μ—” `ObjectOptimisticLockingFailureException` μμ™Έ λ°μƒ μ‹ μ¬μ‹λ„ μν–‰)
- λ¬΄ν• μ¬μ‹λ„ λ°©μ§€ν•κ³ μ **μµλ€ μ¬μ‹λ„ νμ μ ν•**ν•  μ μλ‹¤.

### 3.2 μ μ©ν• μ½”λ“

```kotlin
class μμ‹ {
   @Retryable(
      value = [ObjectOptimisticLockingFailureException::class],
      maxAttempts = 3,
      backoff = Backoff(delay = 200)
   )
   fun charge(command: BalanceChargeCommand) {
      // λΉ„μ¦λ‹μ¤ λ΅μ§
   }
}
```

**μ„¤μ • μƒμ„Έ**

- `value`: `ObjectOptimisticLockingFailureException`λ§ μ¬μ‹λ„ λ€μƒμΌλ΅ μ§€μ •
- `maxAttempts`: μµλ€ 3λ²κΉμ§€ μ¬μ‹λ„ (μ›λ³Έ μ‹¤ν–‰ 1ν + μ¬μ‹λ„ 2ν)
- `backoff.delay`: μ¬μ‹λ„ κ°„κ²©μ„ 200msλ΅ μ„¤μ •ν•μ—¬ μ¶©λ ν™•λ¥  κ°μ†

### 3.3 μ¬μ‹λ„ λ©”μ»¤λ‹μ¦

**μ¬μ‹λ„ ν”λ΅μ°**

1. μ΄κΈ° μ”μ²­ μ‹¤ν–‰ β†’ `OptimisticLockingFailureException` λ°μƒ
2. 200ms λ€κΈ° ν›„ 1μ°¨ μ¬μ‹λ„ β†’ μ‹¤ν¨ μ‹ μ¶”κ°€ 200ms λ€κΈ°
3. 2μ°¨ μ¬μ‹λ„ μν–‰ β†’ μµλ€ 3νκΉμ§€ μ‹λ„
4. λ¨λ“  μ¬μ‹λ„ μ‹¤ν¨ μ‹ μµμΆ… μμ™Έ λ°μƒ

## 4. μ„±λ¥ κ°μ„  κ²°κ³Ό

### 4.1 ν…μ¤νΈ κ²°κ³Ό λΉ„κµ (Spring Retry μ μ© ν›„)

| ν…μ¤νΈ μΌ€μ΄μ¤               | μ μ© μ „ μ„±κ³µ/μ‹¤ν¨  | μ μ© ν›„ μ„±κ³µ/μ‹¤ν¨  | μ„±κ³µλ¥  κ°μ„    |
|-----------------------|-------------|-------------|----------|
| λ€λ‰ ν¬μΈνΈ μ¶©μ „ λ™μ‹μ„± ν…μ¤νΈ     | 38/62 (38%) | 85/15 (85%) | **+47%** |
| μ μ € ν¬μΈνΈ μ°¨κ° λ™μ‹μ„± ν…μ¤νΈ     | 4/6 (40%)   | 9/1 (90%)   | **+50%** |
| μ μ € ν¬μΈνΈ μ¶©μ „ 10λ² λ™μ‹μ„± ν…μ¤νΈ | 4/6 (40%)   | 9/1 (90%)   | **+50%** |

### 4.2 μƒμ„Έ λ¶„μ„

#### 4.2.1 μ„±κ³µμ μΈ κ°μ„  μ‚¬λ΅€

**λ€λ‰ ν¬μΈνΈ μ¶©μ „ λ™μ‹μ„± ν…μ¤νΈ**

- κ°€μ¥ κ·Ήμ μΈ κ°μ„ : 38% β†’ 85% (47% ν–¥μƒ)
- λ†’μ€ λ™μ‹μ„± ν™κ²½μ—μ„ μ¬μ‹λ„μ ν¨κ³Όκ°€ κ·Ήλ€ν™”
- κΈ°μ μ  μ¶©λλ΅ μΈν• μ‹¤ν¨λ¥Ό ν¬κ² κ°μ†

**μΌλ° μ¶©μ „/μ°¨κ° ν…μ¤νΈ**

- 40% β†’ 90%μ μΌκ΄€λ κ°μ„ 
- μ λ‹Ήν• λ™μ‹μ„± ν™κ²½μ—μ„λ„ μ•μ •μ μΈ μ„±λ¥ ν–¥μƒ

## 5. ν•µμ‹¬ μΈμ‚¬μ΄νΈ

### 5.1 Spring Retryμ ν¨κ³Όμ μΈ μ μ© μ΅°κ±΄

1. **κΈ°μ μ  μ¶©λ vs λΉ„μ¦λ‹μ¤ μ‹¤ν¨**
    - λ‚™κ΄€μ  λ½ μ¶©λ: μ¬μ‹λ„λ΅ ν•΄κ²° κ°€λ¥ β…
    - μ”μ•΅ λ¶€μ΅±: μ¬μ‹λ„λ΅ ν•΄κ²° λ¶κ°€λ¥ β

2. **λ™μ‹μ„± μμ¤€κ³Ό κ°μ„  ν¨κ³Ό**
    - λ†’μ€ λ™μ‹μ„± β†’ ν° κ°μ„  ν¨κ³Ό
    - λ‚®μ€ λ™μ‹μ„± β†’ μ ν•μ  κ°μ„  ν¨κ³Ό

3. **λ°±μ¤ν”„ μ „λµμ μ¤‘μ”μ„±**
    - 200ms μ§€μ—°μΌλ΅ μ¶©λ ν™•λ¥  κ°μ†
    - μ‹μ¤ν… λ¶€ν• λ¶„μ‚° ν¨κ³Ό

### 5.2 μ•„ν‚¤ν…μ²μ  μ΄μ 

#### Spring Retryλ¥Ό μ‚¬μ©ν•μ§€ μ•κ³  μμ™Έλ΅ μΈν• μ¬μ‹λ„λ¥Ό ν•  κ²½μ°

```kotlin
try {
    balanceService.charge(command)
} catch (OptimisticLockingFailureException e) {
    // μλ™ μ¬μ‹λ„ λ΅μ§
    Thread.sleep(200)
    balanceService.charge(command)
}
```

#### Spring Retryλ¥Ό μ‚¬μ©ν•  κ²½μ°

```kotlin
@Retryable(
    value = [ObjectOptimisticLockingFailureException::class],
    maxAttempts = 3,
    backoff = Backoff(delay = 200)
)
fun charge(command: BalanceChargeCommand) {
    // λΉ„μ¦λ‹μ¤ λ΅μ§μ—λ§ μ§‘μ¤‘
}
```

## 6. κ²°λ΅ 

Spring Retry μ μ©μ„ ν†µν•΄ λ‚™κ΄€μ  λ½ μ¶©λλ΅ μΈν• μ‹¤ν¨μ¨μ„ ν„μ €ν κ°μ„ λμ—λ‹¤.

νΉν κΈ°μ μ  μ¶©λ μƒν™©μ—μ„ ν‰κ·  47%μ μ„±κ³µλ¥  ν–¥μƒμ„ λ‹¬μ„±ν–μΌλ©°, λΉ„μ¦λ‹μ¤ λ΅μ§μ λ³µμ΅μ„±μ„ μ¦κ°€μ‹ν‚¤μ§€ μ•κ³ λ„ μ‹μ¤ν…μ μ•μ •μ„±μ„ ν¬κ² κ°μ„ λμ—λ‹¤.

**ν•µμ‹¬ μ„±κ³Ό**

- π“ **μ„±κ³µλ¥  λ€ν­ κ°μ„ **: 38% β†’ 85% (λ€λ‰ μ²λ¦¬)
- π― **μ„ νƒμ  μ μ©**: κΈ°μ μ  μ¶©λλ§ λ€μƒμΌλ΅ μ •ν™•ν• μ²λ¦¬
- π”§ **μ½”λ“ κ°„μ†ν™”**: μ„ μ–Έμ  μ–΄λ…Έν…μ΄μ…μΌλ΅ λ³µμ΅ν• μ¬μ‹λ„ λ΅μ§ λ€μ²΄
- π€ **ν™•μ¥μ„± ν™•λ³΄**: λ†’μ€ λ™μ‹μ„± ν™κ²½μ—μ„λ„ μ•μ •μ μΈ μ²λ¦¬ κ°€λ¥