# 요구사항 정의
1. 주요 기능
2. 요구사항 정의서
3. 참고사항

## 주요 기능
1. 잔액 관리
- 잔액 충전 : 사용자가 결제에 사용할 금액 충전
- 잔액 조회 : 현재 보유 잔액 확인

2. 상품 관리
- 상품 조회 : 판매 중인 상품 목록과 상세 정보 조회
- 재고 관리 : 실시간 재고 수량 반영

3. 쿠폰 시스템
- 선착순 쿠폰 발급 : 한정 수량의 할인 쿠폰 발급
- 보유 쿠폰 조회 : 사용자가 보유한 쿠폰 목록 조회

4. 주문 및 결제
- 상품 주문 : 여러 상품을 한 번에 주문
- 결제 처리 : 충전된 잔액으로 결제 진행
- 쿠폰 적용 : 할인 쿠폰 적용한 결제

5. 통계 및 추천
- 인기 상품 조회 : 최근 3일간 가장 많이 판매된 상위 5개 상품 정보 제공

## 요구사항 정의서
### 잔액 관리(기능적 요구사항)
#### 잔액 충전
- [ ] 사용자는 자신의 잔액을 충전할 수 있다.
- [ ] 충전 금액은 0보다 큰 양수여야 한다.
- [ ] 잔고 정보가 존재하지 않을 경우, 새로 생성하고 충전 금액을 저장한다. 
- [ ] 잔고가 이미 존재할 경우, 기존 금액에 충전 금액을 더한다. 
- [ ] 최대 잔액 한도를 설정한다.
- [ ] 충전 후 총 잔액이 최대 한도를 초과하면 충전을 거부한다. 
- [ ] 충전 성공 시 충전 내역을 기록한다. 
- [ ] 충전 완료 후 현재 잔액과 충전 일시를 반환한다. 
- [ ] 동시에 같은 사용자가 충전할 경우 정확한 금액이 반영되어야 한다.

#### 잔액 조회
- [ ] 사용자는 자신의 현재 잔액을 조회할 수 있다.
- [ ] 잔액이 없는 사용자는 0원으로 표시한다.

### 잔액 관리(비기능적 요구사항)
- [ ] 동시성: 동시에 같은 사용자가 충전할 경우, 순차적으로 처리되어 정확한 금액이 반영되어야 한다.

### 상품 관리(기능적 요구사항) 
#### 상품 조회
- [ ] 모든 판매 가능한상품 목록을 조회할 수 있다.
- [ ] 각 상품의 ID, 이름, 가격, 현재 재고량을 표시한다.
- [ ] 품절된 상품도 재고 0으로 표시한다.
- [ ] 조회 시점의 실시간 재고를 반영한다.
- [ ] 상품 목록은 페이징 처리를 지원한다.
- [ ] 상품명으로 검색 기능을 제공한다.
- [ ] 가격 범위로 필터링할 수 있다.

### 상품 관리(비기능적 요구사항)
- [ ] 성능/일관성: 상품 조회 시점의 실시간 재고를 정확하고 빠르게 반영해야 한다.

### 쿠폰 관리(기능적 요구사항)
#### 선착순 쿠폰 발급
- [ ] 사용자는 선착순 쿠폰을 발급받을 수 있다.
- [ ] 쿠폰은 정해진 수량만큼만 발급된다.
- [ ] 한 사용자는 동일한 쿠폰을 중복으로 발급받을 수 없다.
- [ ] 쿠폰 수량이 소진되면 발급이 거부된다.
- [ ] 쿠폰 발급 내역을 기록한다.
- [ ] 만료된 쿠폰은 발급할 수 없다.

#### 보유 쿠폰 조회
- [ ] 사용자는 자신이 보유한 쿠폰 목록을 조회할 수 있다.
- [ ] 각 쿠폰의 ID, 할인율, 유효기간을 표시한다.
- [ ] 사용 여부를 표시한다.
- [ ] 만료된 쿠폰과 유효한 쿠폰을 구분하여 표시한다.
- [ ] 쿠폰은 발급일 기준 내림차순으로 정렬한다.

### 상품 관리(비기능적 요구사항)
- [ ] 동시성: 선착순 쿠폰 발급 시, 다수의 동시 요청이 발생해도 정해진 수량 이상으로 발급되지 않도록 제어해야 한다.
- [ ] 확장성: 여러 서버 환경(Multi-instance)에서도 동시성 제어가 일관되게 동작해야 한다. (분산 락 사용)

### 주문 및 결제(기능적 요구사항)
#### 주문 생성
- [ ] 사용자는 여러 상품을 동시에 주문할 수 있다.
- [ ] 각 상품별로 주문 수량을 지정할 수 있다.
- [ ] 주문 수량은 1개 이상이어야 한다.
- [ ] 재고보다 많은 수량을 주문할 수 없다.
- [ ] 주문 총액을 계산한다.
- [ ] 품절된 상품은 주문할 수 없다.
- [ ] 주문 정보를 임시 저장한다.

#### 쿠폰 적용
- [ ] 주문 시 보유한 쿠폰을 적용할 수 있다.
- [ ] 쿠폰은 선택사항이다.
- [ ] 유효기간이 지난 쿠폰은 사용할 수 없다.
- [ ] 이미 사용한 쿠폰은 재사용할 수 없다.
- [ ] 쿠폰 할인이 전체 주문 금액에 적용된다.
- [ ] 할인 후 금액은 0원 이상이어야 한다.

#### 결제 처리
- [ ] 충전된 잔액으로 결제를 진행한다.
- [ ] 잔액이 부족하면 결제를 거부한다.
- [ ] 결제 성공 시 잔액을 차감한다.
- [ ] 주문한 상품의 재고를 차감한다.
- [ ] 사용한 쿠폰을 사용 처리한다.
- [ ] 주문 번호를 생성하여 반환한다.
- [ ] 최종 결제 금액과 남은 잔액을 반환한다.

#### 외부 시스템 연동
- [ ] 결제 성공 시 주문 정보를 데이터 플랫폼으로 전송한다.
- [ ] 전송 데이터는 주문 ID, 사용자 ID, 상품 정보, 결제 금액을 포함한다.
- [ ] Mock API나 Fake Module로 구현한다.

### 주문 및 결제(비기능적 요구사항)
- [ ] '잔액 차감', '재고 감소', '쿠폰 사용 처리', '주문 상태 변경' 등 결제와 관련된 모든 DB 작업은 하나의 트랜잭션으로 처리되어 원자성을 보장해야 한다. (데이터 무결성)
- [ ] 다수의 주문이 동시에 발생해도 각 상품의 재고가 정확하게 차감되도록 제어해야 한다. (Overselling 방지)
- [ ] 동시성 및 데이터 무결성 이슈를 검증하기 위한 테스트 코드를 반드시 작성해야 한다.

### 통계 및 추천
#### 인기 상품 조회
- [ ] 최근 3일간의 판매 데이터를 기준으로 한다.
- [ ] 판매 수량이 가장 많은 상위 5개 상품을 선정한다.
- [ ] 각 상품의 ID, 이름, 가격을 표시한다.
- [ ] 해당 기간 동안의 총 판매 수량을 표시한다.
- [ ] 순위를 표시한다.(1위부터 5위까지)
- [ ] 판매 데이터가 없으면 빈 목록을 반환한다.

## 참고사항
- 동시성 제어
  - [ ] 재고 관리 : 다수의 주문이 동시에 발생해도 재고가 이중으로 차감되거나 음수가 되지 않도록 동시성을 제어해야 한다. (비관적/낙관적 락)
  - [ ] 쿠폰 발급: 선착순 쿠폰 발급 시, 정해진 수량 이상으로 발급되지 않도록 동시성을 제어해야 한다.
- 데이터 무결성 관련
  - [ ] 원자적 처리: '잔액 차감', '재고 감소', '주문 내역 생성'은 하나의 트랜잭션으로 처리되어 모두 성공하거나 모두 실패해야 한다.
- 멀티 서버 환경
  - [ ] 애플리케이션이 여러 서버 인스턴스로 실행(Scale-out)되더라도 기능(특히 동시성 제어)에 문제가 없어야 한다. (분산 락 사용)
- 테스트 관련
  - [ ] 각 기능 및 제약사항에 대한 단위 테스트(Unit Test)를 반드시 하나 이상 작성해야 한다.